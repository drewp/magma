#!/usr/bin/python
"""
gather all the supervisord.conf files and make nagios checks for all
services plus a web page with links to all services

the nagios checks may be http GET to the service itself, or a
supervisor xmlrpc check to see if the service process is running
(usually a weaker test)
"""
import xmlrpclib, subprocess
from genshi.template import TemplateLoader


def getServices(host):
    addr = "http://%s:9001" % host
    if host == "bang-local":
        host = 'bang'
        addr = "http://bang:9002"
    supervisor = xmlrpclib.Server(addr).supervisor
    def maybePortnum(name):
        tail = row['name'].split('_')[-1]
        try:
            return int(tail)
        except ValueError:
            return None
    return [{'host' : host, 
             'supervisorPort' : int(addr.split(':')[-1]), 
             'servicePort' : maybePortnum(row['name']),
             'name' : row['name']} 
             for row in supervisor.getAllConfigInfo()]

def getAllServices():
    return sum((getServices(h) for h in ['bang', 'bang-local', 'dash', 'slash', 'score']), [])


svcs = getAllServices()

# this multi-file stupidness is because when a nagios config file crosses about
# 12k, nagios truncates it and reports an error on whatever the last
# broken line happens to be. Using nagios 3.2.0-4ubuntu2
out = None
serial = 0
written = 0
for svc in svcs:
    if out is None or written > 50:
        serial += 1
        # warning- doesnt clean up old ones
        out = open("/etc/nagios3/conf.d/supervisor-%s.cfg" % serial, "w")
        out.write("# autogenerated by services_list\n\n")
        written = 0

    out.write("""
define service { 
  use generic-service 
  host_name %(host)s
  service_description %(name)s
  check_command sup_check!%(supervisorPort)s!%(name)s
}
""" % svc)
    written += 1


loader = TemplateLoader(["."])
tmpl = loader.load('services_list.html')
byHost = {}
for svc in svcs:
    if svc['servicePort'] is None:
        continue
    byHost.setdefault(svc['host'], []).append(svc)
stream = tmpl.generate(
    byHost=byHost,
    )

f = open("/my/site/magma/build_services.html", "w")
f.write(stream.render())
f.close()

subprocess.call(['/etc/init.d/nagios3', 'reload'])
# now restart nagios to see its config file
