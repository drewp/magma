#!buildout_bin/py
import os, sys
from twisted.internet import reactor
from twisted.python import log
from twisted.python.util import sibpath
from twisted.web.client import getPage
from twisted.internet.defer import inlineCallbacks, returnValue
from nevow.appserver import NevowSite
from nevow import rend, static, loaders, tags as T, inevow, json
from nevowopenid import WithOpenid, getSessionDict
from rdflib.Graph import Graph
from rdflib import URIRef, Literal, Namespace, Variable
from commandinference.dbclient import nowLiteral, getCommandLog

"""
need ajaxy supervisor interface

this should use openid, with an extra list of magic query params that
also fire the same identity=drewp code that openid can finish
with. then we bookmark the magic urls in our phones

"""

CMD = Namespace("http://bigasterisk.com/ns/command/v1#")

#os.chdir("/my/site/magma")

class Running(rend.Page):
    docFactory = loaders.stan(T.img(src="out"))
    def child_out(self, ctx):
        return static.File("running/out.png")

class Main(rend.Page, WithOpenid):
    def __init__(self, cmdlog):
        self.cmdlog = cmdlog
        
    def child_(self, ctx):
        import homepage
        reload(homepage)
        p = homepage.HomePage(self.cmdlog, self.identity)
        return p

    def needOpenidUrl(self):
        class OpenidLogin(rend.Page):
            form = lambda: T.form(method="post", action="")    
            docFactory = loaders.stan([
                form()["openid: ", T.input(name="openid"),
                       T.input(type='submit', value='login')],
                form()[T.input(type='hidden', name='openid', value='bigasterisk.com'),
                       T.input(type='submit', value='bigasterisk.com')],
                form()[T.input(type='hidden', name='openid',
                               value='https://www.google.com/accounts/o8/id'),
                       T.input(type='submit', value='Use google account')],
                form()[T.input(type='hidden', name='openid', value='yahoo.com'),
                       T.input(type='submit', value='Use yahoo account')],
                    ])
        return OpenidLogin()


    def child_microblogUpdate(self, ctx):
        import microblog, homepage
        reload(microblog)
        return microblog.postAll(self.cmdlog.graph,
                                 homepage.userFromOpenid(self.cmdlog.graph,
                                                         self.identity),
                                 ctx.arg('msg'))
    
    def getOpenidIdentity(self, ctx):
        req = inevow.IRequest(ctx)
        if req.path == '/signin':
            ident = self.identityFromDirectSignin(ctx.arg('d'))
            getSessionDict(ctx)['identity'] = ident
            return ident
            
        return WithOpenid.getOpenidIdentity(self, ctx)

    def identityFromDirectSignin(self, code):
        """a mode for treo cell phones that can't remember
        cookies. They use an https URL with a 'direct login code'
        right in it, which we then authorize as an identity and
        proceed as if it was an openid login.
        """
        rows = list(self.cmdlog.graph.queryd(
          "SELECT ?id WHERE { ?pers cl:openid ?id ; cl:directLoginCode ?code }",
            initBindings={Variable('code') : Literal(code)}))
        if not rows:
            raise ValueError("no login known for URL code")
        return rows[0]['id']
    
    def child_signin(self, ctx):
        # signin page action happens above; this is only a redirect at the end
        inevow.IRequest(ctx).redirect('http://bigasterisk.com/magma/')
        return ''

    def verifyIdentity(self, ctx):
        return # everyone's ok, they just won't get many commands
        # junk:
        #if (URIRef(self.identity), CMD.perm, CMD.allowed) not in self.graph:
        #    raise ValueError("not authorized")

    def fullUrl(self, ctx):
        request = inevow.IRequest(ctx)
        return 'http://bigasterisk.com/magma' + request.path
    
    def child_running(self, ctx):
        return Running()
    def child_net(self, ctx):
        return static.File("nets.html")
    def child_images(self, ctx):
        return static.File("images")
    def child_www(self, ctx):
        return static.File('/my/proj/room/www')
    def child_tango(self, ctx):
        return static.File('/usr/share/icons/Tango/32x32')

for cmd in ['addCommand', 'babyKick', 'babyTable', 'garage']:
    # too scared to touch locateChild on the openid page

    def newchild(self, ctx, cmd=cmd):
        import homepage
        reload(homepage)
        p = homepage.HomePage(self.cmdlog, self.identity)
        return getattr(p, 'child_%s' % cmd)(ctx)

    setattr(Main, 'child_%s' % cmd, newchild)
    

setattr(Main, "child_dojo-0.4.2-ajax", static.File("dojo-0.4.2-ajax"))

log.startLogging(sys.stdout)

#graph = Graph()
#for f in ['auth.n3', 'datapoint.n3']:
#    graph.parse("commandinference/%s" % f, format="n3")


cmdlog = getCommandLog()
cmdlog.newCommandPing(signal='hi', content='world')

reactor.listenTCP(8006, NevowSite(Main(cmdlog)))
reactor.run()
